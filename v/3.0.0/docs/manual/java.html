<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Direct Access In Android Applications &mdash; SyNAP 3.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Neural Network Processing Unit Operator Support" href="npu_operators.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            SyNAP
          </a>
              <div class="version">
                3.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="nnapi.html">Using Online Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmark.html">Reference Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="statistics.html">Statistics And Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_models.html">Working With Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="framework_api.html">Framework API</a></li>
<li class="toctree-l1"><a class="reference internal" href="npu_operators.html">Neural Network Processing Unit Operator Support</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Direct Access In Android Applications</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SyNAP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Direct Access In Android Applications</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="direct-access-in-android-applications">
<h1>Direct Access In Android Applications<a class="headerlink" href="#direct-access-in-android-applications" title="Permalink to this headline">ÔÉÅ</a></h1>
<p>In Android, in addition to NN API, SyNAP can be directly accessed by applications. Direct access
to SyNAP main benefits are zero-copy input/output and execution of optimized models compiled ahead
of time with the SyNAP toolkit.</p>
<p>Access to SyNAP can be performed via custom JNI C++ code using the <code class="docutils literal notranslate"><span class="pre">synapnb</span></code> library. The library
can be used as usual, the only constraint is to use the Synap allocator, which can be
obtained with <code class="docutils literal notranslate"><span class="pre">synap_allocator()</span></code>.</p>
<p>Another option, is to use custom JNI C code using the <code class="docutils literal notranslate"><span class="pre">synap_device</span></code> library. In this case there
are no constraints. The library allows to create new I/O buffers with the function
<code class="docutils literal notranslate"><span class="pre">synap_allocate_io_buffer</span></code>. It is also possible to use existing DMABUF handles obtained for
instance from gralloc with <code class="docutils literal notranslate"><span class="pre">synap_create_io_buffer</span></code>. The DMABUF can be accessed with standard
Linux DMABUF APIs (i.e. mmap/munmap/ioctls).</p>
<p>SyNAP provides a sample JNI library that shows how to use the <code class="docutils literal notranslate"><span class="pre">synap_device</span></code> library in a Java
application. The code is located in <code class="docutils literal notranslate"><span class="pre">java</span></code> and can be included in an existing Android application
by adding the following lines to the <code class="docutils literal notranslate"><span class="pre">settings.gradle</span></code> of the application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="s1">&#39;:synap&#39;</span>
<span class="n">project</span><span class="p">(</span><span class="s1">&#39;:synap&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">projectDir</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="s2">&quot;[absolute path to synap]/java&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The code can then be used as follows:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">com.synaptics.synap</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InferenceEngine</span> <span class="p">{</span>

    <span class="cm">/**</span>
<span class="cm">     * Perform inference using the model passed in  data</span>
<span class="cm">     *</span>
<span class="cm">     * @param model EBG model</span>
<span class="cm">     * @param inputs arrays containing model input data, one byte array per network input,</span>
<span class="cm">     *               of the size expected by the network</span>
<span class="cm">     * @param outputs arrays where to store output of the network, one byte array per network</span>
<span class="cm">     *                output, of the size expected by the network</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">infer</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">model</span><span class="p">,</span> <span class="kt">byte</span><span class="o">[][]</span> <span class="n">inputs</span><span class="p">,</span> <span class="kt">byte</span><span class="o">[][]</span> <span class="n">outputs</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">Synap</span> <span class="n">synap</span> <span class="o">=</span> <span class="n">Synap</span><span class="p">.</span><span class="na">getInstance</span><span class="p">();</span>

        <span class="c1">// load the network</span>
        <span class="n">Network</span> <span class="n">network</span> <span class="o">=</span> <span class="n">synap</span><span class="p">.</span><span class="na">createNetwork</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>

        <span class="c1">// create input buffers and attach them to the network</span>
        <span class="n">IoBuffer</span><span class="o">[]</span> <span class="n">inputBuffers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IoBuffer</span><span class="o">[</span><span class="n">inputs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span>
        <span class="n">Attachment</span><span class="o">[]</span> <span class="n">inputAttachments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Attachment</span><span class="o">[</span><span class="n">inputs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inputs</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// create the input buffer of the desired length</span>
            <span class="n">inputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">synap</span><span class="p">.</span><span class="na">createIoBuffer</span><span class="p">(</span><span class="n">inputs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>

            <span class="c1">// attach the buffer to the network (make sure you keep a reference to the</span>
            <span class="c1">// attachment to avoid it is garbage collected and destroyed)</span>
            <span class="n">inputAttachments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">network</span><span class="p">.</span><span class="na">attachIoBuffer</span><span class="p">(</span><span class="n">inputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>

            <span class="c1">// set the buffer as the i-th input of the network</span>
            <span class="n">inputAttachments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">useAsInput</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

            <span class="c1">// copy the input data to the buffer</span>
            <span class="n">inputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">copyFromBuffer</span><span class="p">(</span><span class="n">inputs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inputs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// create the output buffers and attach them to the network</span>
        <span class="n">IoBuffer</span><span class="o">[]</span> <span class="n">outputBuffers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IoBuffer</span><span class="o">[</span><span class="n">outputs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span>
        <span class="n">Attachment</span><span class="o">[]</span> <span class="n">outputAttachments</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Attachment</span><span class="o">[</span><span class="n">inputs</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">outputs</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// create the output buffer of the desired length</span>
            <span class="n">outputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">synap</span><span class="p">.</span><span class="na">createIoBuffer</span><span class="p">(</span><span class="n">outputs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>

            <span class="c1">// attach the buffer to the network (make sure you keep a reference to the</span>
            <span class="c1">// attachment to avoid it is garbage collected and destroyed)</span>
            <span class="n">outputAttachments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">network</span><span class="p">.</span><span class="na">attachIoBuffer</span><span class="p">(</span><span class="n">outputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">);</span>

            <span class="c1">// set the buffer as the i-th output of the network</span>
            <span class="n">outputAttachments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">useAsOutput</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// run the network</span>
        <span class="n">network</span><span class="p">.</span><span class="na">run</span><span class="p">();</span>

        <span class="c1">// copy the result data to the output buffers</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">outputs</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">outputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">copyToBuffer</span><span class="p">(</span><span class="n">outputs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">outputs</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// release resources (it will be done automatically when the objects are garbage</span>
        <span class="c1">// collected but this may take some time so it is better to release them explicitly</span>
        <span class="c1">// as soon as possible)</span>

        <span class="n">network</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>  <span class="c1">// this will automatically release the attachments</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inputs</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">inputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">outputs</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">outputBuffers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To simplify application development by default VSSDK allows untrusted applications (such as
application sideloaded or downloaded from Google Play store) to use the SyNAP API. Since the
API uses limited hardware resources this can lead to situations in which a 3rd party
application interferes with platform processes. To restrict access to SyNAP only to
platform applications remove the file <code class="docutils literal notranslate"><span class="pre">vendor/vsi/sepolicy/synap_device/untrusted_app.te</span></code>.</p>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="npu_operators.html" class="btn btn-neutral float-left" title="Neural Network Processing Unit Operator Support" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, 2022, 2023, 2024, Synaptics.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>